<!DOCTYPE html>
<html>
<head>
	<title>Query Builder</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/css/style.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script type="text/javascript" src="/static/js/javascript.js"></script>
</head>
<body>

	<h1 style="width: 30vw;position: fixed;top: 0;">{% print("Query Builder") %}</h1>
	<p id="output" style="width:fit-content;max-width:75vw;position:relative;left:20vw;height:5vh;">Output: </p>
	<button id="btn-all" style="position: relative;">All Fields</button>
	<button id="btn-output" style="position: relative;">Query</button>
	<button id="btn-clear" style="position: relative;">Clear</button>
	<button id="btn-csv" style="position: relative;">Download as .csv</button>
	<button id="btn-save" style="position: relative;">Save Query</button>

	<section class="query-container">
		<section class="fields">
			<script type="text/javascript">
				function onlyUnique(value, index, self) { 
				    return self.indexOf(value) === index;
				}
				function capwords(str) {
					return str.toLowerCase().split(' ').map(x=>x[0].toUpperCase()+x.slice(1)).join(' ');
				}
				function sqlToDisplay(str) {
					str = str.replace(str, "_", " ")
					str = str.capwords(str)
					str = str.replace(str, "P Nomenclature", "P.nomenclature")
					str = str.replace(str, "C Nomenclature", "C.nomenclature")
					str = str.replace(str, "Mrn", "MRN")
					str = str.replace(str, "Dob", "DOB")
					str = str.replace(str, "Id", "ID")
					str = str.replace(str, "Dna", "DNA")
					str = str.replace(str, "Pcr", "PCR")
					str = str.replace(str, "Mlpa", "MLPA")
					str = str.replace(str, "Se ", "SE ")
					str = str.replace(str, "Rna", "RNA")
					str = str.replace(str, "On", "ON")
					str = str.replace(str, "Hcn", "HCN")
					str = str.replace(str, "Vaf", "VAF")
					str = str.replace(str, "Panel Assay", "Panel/Assay")
					str = str.replace(str, "Wbc", "WBC")
					str = str.replace(str, "Pb Bm", "PB/BM")
					str = str.replace(str, "Cf", "cf")
					str = str.replace(str, "Uhn", "UHN")

					return str;
				}
				
				var tables = [];
				var tFields = [], fields = [], i;
				var doc;
				
				$.getJSON("http://172.27.164.207:8000/Jtree/metadata/0.1.0/columns", function(data) {
					tables = data;
					for (i = 0; i < tables.length; i++) {
						var str = tables[i].split(".");
						tFields.push(str[0]);
						fields.push(str[1]);
					}
					tables = tFields.filter(onlyUnique);
					var j = 0;
					for (let i = 0; i < fields.length; i++) {
						fields[i] = sqlToDisplay(fields[i]);
					}
					for (i = 0; i < tables.length; i++) {
						var li = document.createElement('li');
						var a = document.createElement('a');
						a.innerHTML = tables[i].charAt(0).toUpperCase() + tables[i].slice(1) + " Fields";
						li.setAttribute("class", "tables");
						li.appendChild(a);
						$(".fields").append(li);
						var ul = document.createElement('ul');
						while (tFields[j] == tables[i]) {
							var li = document.createElement('li');
							var a = document.createElement('a');
							a.setAttribute("class", "cols");
							a.innerHTML = fields[j];
							li.appendChild(a);
							ul.appendChild(li);
							j++;
						}
						$(".fields").append(ul);
					}
				});
			</script>
		</section>

		<section class="controls">
			<article class="control-condition" id="control-0">
				<label>Field: </label>
				<select id="control-logic">
					<option>AND</option>
					<option>OR</option>
				</select>
				<input id="control-field" list="results-datalist">
				<datalist id="results-datalist"></datalist>
				<select id="operator-option"></select>
				<input id="control-input">
				<button class="btn-add">Add</button>
				<button class="btn-delete">Delete</button>
			</article>
			
		</section>
		<div class="results">
			<table id="table_results">
				<tr id="table_header"></tr>
			</table>

		</div>
	</section>
</body>
</html>
